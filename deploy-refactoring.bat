@echo off
chcp 65001 >nul
cls

echo ╔════════════════════════════════════════════════════════════╗
echo ║                                                            ║
echo ║    🔧 Deploy - Глубокий Рефакторинг                       ║
echo ║                                                            ║
echo ╚════════════════════════════════════════════════════════════╝
echo.

echo 📝 Критические исправления:
echo.
echo ✅ Аналитика - периоды теперь показывают разные данные
echo ✅ "Всё время" больше не показывает нули
echo ✅ Топ протоколы - только реальные dApps (без адреса пользователя)
echo ✅ NFT - загрузка до 300 NFT (было 33)
echo ✅ Картинки NFT - реальные изображения из IPFS
echo ✅ Коллекции - группировка по collection_id
echo.

git status >nul 2>&1
if errorlevel 1 (
    echo ❌ Не Git репозиторий!
    pause
    exit /b 1
)

echo ⏳ Добавляю исправленные файлы...
git add src/services/nearService.js
git add webapp/src/components/GalleryScreen.jsx
git add REFACTORING.md

echo ⏳ Создаю коммит...
git commit -m "refactor: глубокий рефакторинг аналитики и NFT" -m "🔧 Исправления аналитики:" -m "- Динамический лимит транзакций (100/200/300 в зависимости от периода)" -m "- 7 и 30 дней теперь показывают разные данные" -m "- Период 'Всё время' корректно отображает данные за 90 дней" -m "- Исключён адрес пользователя из топ протоколов" -m "- Топ протоколы и 'Самый активный' показывают только реальные dApps" -m "" -m "🎨 Масштабирование NFT:" -m "- Пагинация: загрузка до 300 NFT (3 страницы по 100)" -m "- Конвертация IPFS URL в HTTP для отображения картинок" -m "- Исправлены пути к metadata (media, title, description)" -m "- Множественные fallback для разных структур данных" -m "" -m "🗂️ Улучшение галереи:" -m "- Группировка NFT по collection_id (не только contract)" -m "- Сортировка коллекций по количеству NFT" -m "- Счётчик NFT в каждой коллекции" -m "- HOT NFT с визуальными маркерами 🔥 (уже было)" -m "" -m "📊 Результаты:" -m "- 7 критических багов исправлено" -m "- 300 NFT доступно (было 33)" -m "- 300 транзакций для аналитики (было 50)" -m "- Реальные картинки вместо заглушек"

if errorlevel 1 (
    echo ❌ Ошибка коммита! Возможно нет изменений.
    pause
    exit /b 1
)

echo ⏳ Отправляю на GitHub...
git push

if errorlevel 1 (
    echo ❌ Ошибка push!
    pause
    exit /b 1
)

echo.
echo ╔════════════════════════════════════════════════════════════╗
echo ║                                                            ║
echo ║         ✅ Рефакторинг успешно задеплоен!                 ║
echo ║                                                            ║
echo ╚════════════════════════════════════════════════════════════╝
echo.
echo 🎉 Railway и Vercel автоматически обновятся через 1-2 минуты
echo.
echo 📊 Проверьте после деплоя:
echo    - Аналитика: разные данные для 7/30/90 дней
echo    - Топ протоколы: только dApps (нет leninjiv23.tg)
echo    - Галерея: 300+ NFT с реальными картинками
echo.
echo 📖 Документация: REFACTORING.md
echo.

pause
